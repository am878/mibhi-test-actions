# workflows to sync certain files when changes are pushed to the master branch
name: Sync

on:
  push:
    branches:
      - 'main'
    paths:
      - 'README.md'
  pull_request:
    branches:
      - 'main'
    paths:
      - 'config/crd/bases/**.yaml'
      - 'charts/aws-pca-issuer/crds/**.yaml'

env:
  GITHUB_USER_NAME: github-actions
  GITHUB_USER_EMAIL: github-actions@github.com
  GH_PAGES_BRANCH: gh-pages
  CONFIG_DIR: config/crd/bases
  CHARTS_DIR: charts/aws-pca-issuer/crds

jobs:
  sync-readme:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ env.GH_PAGES_BRANCH }}
      - name: Push README to gh-pages branch
        run: |
          git config user.name "$GITHUB_USER_NAME"
          git config user.email "$GITHUB_USER_EMAIL"
          git fetch -a
          git checkout $GITHUB_SHA -- README.md
          mv README.md index.md
          git add index.md README.md
          if git commit -m "Sync readme from commit $GITHUB_SHA"; then
            git push origin $GH_PAGES_BRANCH
          else
            echo "Nothing committed, not pushing."
          fi

  sync-crds:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check for different CRDs
        continue-on-error: true
        run: |
          for config_file in $CONFIG_DIR/*.yaml; do
            chart_file=$CHARTS_DIR/$(basename $config_file)
            if ! diff $config_file $chart_file; then
              echo "${config_file} and ${chart_file} are different"
              exit 1
            fi
          done

      - name: Copy CRDs to helm chart
        if: ${{ failure() }}
        run: |
          cp config/crd/bases/*.yaml charts/aws-pca-issuer/crds/

      - name: Update pull request
        if: ${{ failure() }}
        uses: gr2m/create-or-update-pull-request-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: ${{ github.head_ref }}
          path: "charts/"
          commit-message: "Sync CRDs from config to charts from commit ${{ github.sha }}"
          author: "${{ env.GITHUB_USER_NAME }} <${{ env.GITHUB_USER_EMAIL }}>"

      - name: Comment on pull request
        if: ${{ failure() }}
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: 'Detected different CRDs in the `config/crd/bases` directory and `charts/aws-pca-issuer/crds` directory. These CRDs have been synced and the commit has been added to this PR.'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
